#
# BEGIN SONGBIRD GPL
#
# This file is part of the Songbird web player.
#
# Copyright(c) 2005-2008 POTI, Inc.
# http://www.songbirdnest.com
#
# This file may be licensed under the terms of of the
# GNU General Public License Version 2 (the GPL).
#
# Software distributed under the License is distributed
# on an AS IS basis, WITHOUT WARRANTY OF ANY KIND, either
# express or implied. See the GPL for the specific language
# governing rights and limitations.
#
# You should have received a copy of the GPL along with this
# program. If not, go to http://www.gnu.org/licenses/gpl.html
# or write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
#
# END SONGBIRD GPL
#

DEPTH = ..
topsrcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@

include $(DEPTH)/build/autodefs.mk

SUBDIRS = vendor/mozilla

# XXXredfive -erhn?
SONGBIRD_MAIN_APP = $(SONGBIRD_XULRUNNERDIR)/songbird$(BIN_SUFFIX)

GUNZIP_SRC = $(XULRUNNER_DIR)/xulrunner.tar.gz
GUNZIP_DEST_DIR = $(SONGBIRD_XULRUNNERDIR)

ifeq (windows,$(SB_PLATFORM))

ifdef MEDIA_CORE_VLC
VLC_PLUGIN = npvlc
SONGBIRD_PLUGINS += $(DEPS_DIR)/plugins/vlc/plugins/*$(DLL_SUFFIX)

SONGBIRD_VLCPLUGINS = $(DEPS_DIR)/plugins/vlc/plugins/plugins/*$(DLL_SUFFIX) \
                      $(NULL)
endif

SONGBIRD_DIST = $(DEPS_DIR)/id3lib/$(SB_CONFIGURATION)/bin/*$(DLL_SUFFIX) \
                $(DEPS_DIR)/taglib/$(SB_CONFIGURATION)/bin/*$(DLL_SUFFIX) \
                $(DEPS_DIR)/runtime/$(SB_CONFIGURATION)/*$(DLL_SUFFIX) \
                $(NULL)

# have to put the dlls here too because updater can't copy yet
SONGBIRD_XULRUNNER = $(DEPS_DIR)/runtime/$(SB_CONFIGURATION)/*$(DLL_SUFFIX) 

# MSVC 8 needs the manifest files
ifeq ($(_MSC_VER), 1400)
SONGBIRD_DIST += $(DEPS_DIR)/runtime/$(SB_CONFIGURATION)/*.manifest
# have to put the manifest here too because updater can't copy yet
SONGBIRD_XULRUNNER += $(DEPS_DIR)/runtime/$(SB_CONFIGURATION)/*.manifest
endif # _MSC_VER==1400

endif # windows

ifeq (linux,$(SB_PLATFORM))

SONGBIRD_XULRUNNER += $(DEPS_DIR)/taglib/$(SB_CONFIGURATION)/lib/libtag.so*

# non-existent variable, VLC no-worky on linux yet...
ifdef (MEDIA_CORE_VLC)
ifdef (SB_LINUX_VLC)
VLC_PLUGIN = libvlcplugin

SONGBIRD_PLUGINS += $(PLUGINS_DIR)/vlc/plugins/$(VLC_PLUGIN)$(DLL_SUFFIX)
SONGBIRD_COMPONENTS += $(PLUGINS_DIR)/vlc/components/vlcintf.xpt
SONGBIRD_VLCPLUGINS = $(PLUGINS_DIR)/vlc/vlcplugins/*$(DLL_SUFFIX)
endif # SB_LINUX_VLC

SONGBIRD_XULRUNNER += $(DEPS_DIR)/id3lib/$(SB_CONFIGURATION)/lib/libid3-3.8.so.3.0.0 \
                      $(DEPS_DIR)/id3lib/$(SB_CONFIGURATION)/lib/libid3-3.8.so.3 \
                      $(DEPS_DIR)/id3lib/$(SB_CONFIGURATION)/lib/libid3.so \
                      $(NULL)
endif # MEDIA_CORE_VLC

endif # linux

ifeq (macosx,$(SB_PLATFORM))

all:: runtimelibs

ifdef MEDIA_CORE_VLC
all:: vlcplugin
endif

runtimelibs::
	$(MKDIR) -p $(SONGBIRD_MACOS)
	$(CP) -dfp $(DEPS_DIR)/id3lib/$(SB_CONFIGURATION)/lib/*$(DLL_SUFFIX) \
               $(DEPS_DIR)/taglib/$(SB_CONFIGURATION)/lib/*$(DLL_SUFFIX) \
               $(DEPS_DIR)/libogg/$(SB_CONFIGURATION)/lib/*$(DLL_SUFFIX) \
               $(SONGBIRD_MACOS) \
               $(NULL)

# Plugins on OS X are not files but rather directories! Doing it this way
# keeps us from having to remove a bunch of '.svn' folders after a recursive
# directory copy.

VLC_TAR_FILENAME = VLC\ Plugin.tar.gz

vlcplugin::
	$(MKDIR) -p $(SONGBIRD_PLUGINSDIR)
	$(TAR) -z -x -f $(DEPS_DIR)/plugins/vlc/$(SB_CONFIGURATION)/$(VLC_TAR_FILENAME) \
    -C $(SONGBIRD_PLUGINSDIR)

endif

# GStreamer
ifdef MEDIA_CORE_GST

GST_VERSION=0.10
GLIB_VERSION=2.0
OIL_VERSION=0.3

GLIB_NAMES = glib \
             gmodule \
             gobject \
             gthread \
             $(NULL)

LIBICONV_NAMES = charset \
                 iconv \
                 $(NULL)

GETTEXT_NAMES = gettextlib \
                gettextpo \
                gettextsrc \
                intl \
                $(NULL)

GSTREAMER_NAMES = gstreamer \
                  gstbase \
                  gstcontroller \
                  gstdataprotocol \
                  gstnet \
                  $(NULL)

GST_PLUGINS_BASE_LIBS_NAMES = gstaudio \
                              gstcdda \
                              gstfft \
                              gstinterfaces \
                              gstnetbuffer \
                              gstpbutils \
                              gstriff \
                              gstrtp \
                              gstrtsp \
                              gstsdp \
                              gsttag \
                              gstvideo \
                              $(NULL)

OGG_NAMES = ogg \
            $(NULL)

VORBIS_NAMES = vorbis \
               vorbisenc \
               vorbisfile \
               $(NULL)

OIL_NAMES = oil \
            $(NULL)

GST_PLUGINS_CORE_NAMES = gstcoreelements \
                         gstcoreindexers \
                         $(NULL)

GST_PLUGINS_BASE_NAMES = gstadder \
                         gstaudioconvert \
                         gstaudiorate \
                         gstaudioresample \
                         gstaudiotestsrc \
                         gstdecodebin \
                         gstdecodebin2 \
                         gstffmpegcolorspace \
                         gstgdp \
                         gstogg \
                         gstplaybin \
                         gstqueue2 \
                         gsttypefindfunctions \
                         gstvideorate \
                         gstvideoscale \
                         gstvideotestsrc \
                         gstvolume \
                         gstvorbis \
                         $(NULL)

GST_PLUGINS_GOOD_NAMES = gstalaw \
                         gstalpha \
                         gstalphacolor \
                         gstapetag \
                         gstaudiofx \
                         gstauparse \
                         gstautodetect \
                         gstavi \
                         gstcutter \
                         gstdebug \
                         gsteffectv \
                         gstequalizer \
                         gstflxdec \
                         gstgamma \
                         gstgoom \
                         gsticydemux \
                         gstid3demux \
                         gstlevel \
                         gstmatroska \
                         gstmulaw \
                         gstmultifile \
                         gstmultipart \
                         gstnavigationtest \
                         gstqtdemux \
                         gstrtp \
                         gstrtsp \
                         gstsmpte \
                         gstspectrum \
                         gstudp \
                         gstvideobalance \
                         gstvideobox \
                         gstvideocrop \
                         gstvideoflip \
                         gstvideomixer \
                         gstwavenc \
                         gstwavparse \
                         $(NULL)

GST_PLUGINS_BAD_NAMES = gstreplaygain \
                        $(NULL)

ifeq (windows,$(SB_PLATFORM))

GST_PLUGINS_GOOD_NAMES += gstdirectdrawsink \
                          gstdirectsoundsink \
                          $(NULL)

GLIB = $(addprefix $(DEPS_DIR)/glib/$(SB_CONFIGURATION)/bin/lib, \
         $(addsuffix -$(GLIB_VERSION)-0$(DLL_SUFFIX), $(GLIB_NAMES)))

LIBICONV = $(addprefix $(DEPS_DIR)/libiconv/$(SB_CONFIGURATION)/bin/, \
             $(addsuffix $(DLL_SUFFIX), $(LIBICONV_NAMES)))

GETTEXT = $(addprefix $(DEPS_DIR)/gettext/$(SB_CONFIGURATION)/bin/, \
            $(addsuffix $(DLL_SUFFIX), $(GETTEXT_NAMES)))

# XXX remove the filter-out stuff when new gst lands
GSTREAMER = $(addprefix $(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/bin/, \
              $(addsuffix -$(GST_VERSION)-0$(DLL_SUFFIX), \
                $(filter-out gstnet, $(GSTREAMER_NAMES))))

GST_PLUGINS_BASE_LIBS = $(addprefix $(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/bin/, \
                          $(addsuffix -$(GST_VERSION)-0$(DLL_SUFFIX), $(GST_PLUGINS_BASE_LIBS_NAMES)))

OGG = $(addprefix $(DEPS_DIR)/libogg/$(SB_CONFIGURATION)/bin/, \
        $(addsuffix $(DEBUG:%=_d)$(DLL_SUFFIX), $(OGG_NAMES)))

LIBICONV = $(addprefix $(DEPS_DIR)/libiconv/$(SB_CONFIGURATION)/bin/, \
             $(addsuffix $(DLL_SUFFIX), $(LIBICONV_NAMES)))

# XXX We need to append the version numbers of the libraries
VORBIS_VERSIONED_NAMES = $(join $(VORBIS_NAMES), -0 -2 -3)
VORBIS = $(addprefix $(DEPS_DIR)/libvorbis/$(SB_CONFIGURATION)/lib/lib, \
           $(addsuffix $(DLL_SUFFIX), $(VORBIS_VERSIONED_NAMES)))

OIL = $(addprefix $(DEPS_DIR)/liboil/$(SB_CONFIGURATION)/bin/, \
        $(addsuffix -$(OIL_VERSION)-0$(DLL_SUFFIX), $(OIL_NAMES)))

GST_PLUGINS_CORE = $(addprefix $(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/lib/gstreamer-0.10/, \
                     $(addsuffix $(DLL_SUFFIX), $(GST_PLUGINS_CORE_NAMES)))

GST_PLUGINS_BASE = $(addprefix $(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/lib/gstreamer-0.10/, \
                     $(addsuffix $(DLL_SUFFIX), $(GST_PLUGINS_BASE_NAMES)))

GST_PLUGINS_GOOD = $(addprefix $(DEPS_DIR)/gst-plugins-good/$(SB_CONFIGURATION)/lib/gstreamer-0.10/, \
                     $(addsuffix $(DLL_SUFFIX), $(GST_PLUGINS_GOOD_NAMES)))

GST_PLUGINS_BAD = $(addprefix $(DEPS_DIR)/gst-plugins-bad/$(SB_CONFIGURATION)/lib/gstreamer-0.10/, \
                    $(addsuffix $(DLL_SUFFIX), $(GST_PLUGINS_BAD_NAMES)))

SONGBIRD_LIB += $(GLIB) \
                $(LIBICONV) \
                $(GETTEXT) \
                $(GSTREAMER) \
                $(GST_PLUGINS_BASE_LIBS) \
                $(OGG) \
                $(VORBIS) \
                $(OIL) \
                $(NULL)

SONGBIRD_GST_PLUGINS += $(GST_PLUGINS_CORE) \
                        $(GST_PLUGINS_BASE) \
                        $(GST_PLUGINS_GOOD) \
#                        $(GST_PLUGINS_BAD) \
                        $(NULL)

endif # windows

ifeq (macosx,$(SB_PLATFORM))

GST_PLUGINS_GOOD_NAMES += gstosxaudio \
                          gstosxvideosink \
                          $(NULL)

GST_PLUGINS_BAD_NAMES += gstqtwrapper \
                         $(NULL)

GLIB = $(addprefix $(DEPS_DIR)/glib/$(SB_CONFIGURATION)/lib/lib, \
         $(addsuffix -$(GLIB_VERSION)$(DLL_SUFFIX), $(GLIB_NAMES)))

LIBICONV = $(addprefix $(DEPS_DIR)/libiconv/$(SB_CONFIGURATION)/lib/lib, \
             $(addsuffix $(DLL_SUFFIX), $(LIBICONV_NAMES)))

GETTEXT = $(addprefix $(DEPS_DIR)/gettext/$(SB_CONFIGURATION)/lib/lib, \
            $(addsuffix $(DLL_SUFFIX), $(GETTEXT_NAMES)))

GSTREAMER = $(addprefix $(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/lib/lib, \
              $(addsuffix -$(GST_VERSION)$(DLL_SUFFIX), $(GSTREAMER_NAMES)))

GST_PLUGINS_BASE_LIBS = $(addprefix $(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/lib/lib, \
                          $(addsuffix -$(GST_VERSION)$(DLL_SUFFIX), $(GST_PLUGINS_BASE_LIBS_NAMES)))

OGG = $(addprefix $(DEPS_DIR)/libogg/$(SB_CONFIGURATION)/lib/lib, \
        $(addsuffix $(DLL_SUFFIX), $(OGG_NAMES)))

VORBIS = $(addprefix $(DEPS_DIR)/libvorbis/$(SB_CONFIGURATION)/lib/lib, \
           $(addsuffix $(DLL_SUFFIX), $(VORBIS_NAMES)))

OIL = $(addprefix $(DEPS_DIR)/liboil/$(SB_CONFIGURATION)/lib/lib, \
        $(addsuffix -$(OIL_VERSION)$(DLL_SUFFIX), $(OIL_NAMES)))

GST_PLUGINS_CORE = $(addprefix $(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                     $(addsuffix .so, $(GST_PLUGINS_CORE_NAMES)))

GST_PLUGINS_BASE = $(addprefix $(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                     $(addsuffix .so, $(GST_PLUGINS_BASE_NAMES)))

GST_PLUGINS_GOOD = $(addprefix $(DEPS_DIR)/gst-plugins-good/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                     $(addsuffix .so, $(GST_PLUGINS_GOOD_NAMES)))

GST_PLUGINS_BAD = $(addprefix $(DEPS_DIR)/gst-plugins-bad/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                    $(addsuffix .so, $(GST_PLUGINS_BAD_NAMES)))

SONGBIRD_LIB += $(GLIB) \
                $(LIBICONV) \
                $(GETTEXT) \
                $(GSTREAMER) \
                $(GST_PLUGINS_BASE_LIBS) \
                $(OGG) \
                $(VORBIS) \
                $(OIL) \
                $(NULL)

SONGBIRD_GST_PLUGINS += $(GST_PLUGINS_CORE) \
                        $(GST_PLUGINS_BASE) \
                        $(GST_PLUGINS_GOOD) \
                        $(GST_PLUGINS_BAD) \
                        $(NULL)

endif # macosx

# everything but macosx and windows
ifneq (,$(filter-out macosx windows,$(SB_PLATFORM)))

GST_PLUGINS_BASE_NAMES += gstalsa \
                          gstximagesink \
                          gstxvimagesink
                          $(NULL)

GSTREAMER = $(addprefix $(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/lib/lib, \
              $(addsuffix -$(GST_VERSION)$(DLL_SUFFIX), $(GSTREAMER_NAMES)))

GST_PLUGINS_BASE_LIBS = $(addprefix $(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/lib/lib, \
                          $(addsuffix -$(GST_VERSION)$(DLL_SUFFIX), $(GST_PLUGINS_BASE_LIBS_NAMES)))

OGG = $(addprefix $(DEPS_DIR)/libogg/$(SB_CONFIGURATION)/lib/lib, \
        $(addsuffix $(DLL_SUFFIX), $(OGG_NAMES)))

VORBIS = $(addprefix $(DEPS_DIR)/libvorbis/$(SB_CONFIGURATION)/lib/lib, \
           $(addsuffix $(DLL_SUFFIX), $(VORBIS_NAMES)))

OIL = $(addprefix $(DEPS_DIR)/liboil/$(SB_CONFIGURATION)/lib/lib, \
        $(addsuffix -$(OIL_VERSION)$(DLL_SUFFIX), $(OIL_NAMES)))

GST_PLUGINS_CORE = $(addprefix $(DEPS_DIR)/gstreamer/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                     $(addsuffix .so, $(GST_PLUGINS_CORE_NAMES)))

GST_PLUGINS_BASE = $(addprefix $(DEPS_DIR)/gst-plugins-base/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                     $(addsuffix .so, $(GST_PLUGINS_BASE_NAMES)))

GST_PLUGINS_GOOD = $(addprefix $(DEPS_DIR)/gst-plugins-good/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                     $(addsuffix .so, $(GST_PLUGINS_GOOD_NAMES)))

GST_PLUGINS_BAD = $(addprefix $(DEPS_DIR)/gst-plugins-bad/$(SB_CONFIGURATION)/lib/gstreamer-0.10/lib, \
                    $(addsuffix .so, $(GST_PLUGINS_BAD_NAMES)))

SONGBIRD_LIB += $(GSTREAMER) \
                $(GST_PLUGINS_BASE_LIBS) \
                $(OGG) \
                $(VORBIS) \
                $(OIL) \
                $(NULL)

SONGBIRD_GST_PLUGINS += $(GST_PLUGINS_CORE) \
                        $(GST_PLUGINS_BASE) \
                        $(GST_PLUGINS_GOOD) \
#                        $(GST_PLUGINS_BAD) \
                        $(NULL)

endif # not mac or windows

endif # MEDIA_CORE_GST

ifeq (macosx,$(SB_PLATFORM))
EXECUTABLE = $(SONGBIRD_XULRUNNERDIR)/xulrunner-bin$(BIN_SUFFIX)
else
EXECUTABLE = $(SONGBIRD_XULRUNNERDIR)/xulrunner$(BIN_SUFFIX)
endif

include $(topsrcdir)/build/rules.mk

# Move all extensions from XULRUNNERDIR/extensions to SONGBIRD_EXTENSIONSDIR
xulrunner_extensions = $(notdir $(wildcard $(SONGBIRD_XULRUNNERDIR)/extensions/*))

all:: copy-extensions

.PHONY : copy-extensions
copy-extensions : gunzip_file
	@echo $(xulrunner_extensions)
	$(MKDIR) -p $(SONGBIRD_EXTENSIONSDIR)
	for item in $(xulrunner_extensions); do \
    $(RM) -rf $(SONGBIRD_EXTENSIONSDIR)/$$item; \
    $(MV) -f $(SONGBIRD_XULRUNNERDIR)/extensions/$$item $(SONGBIRD_EXTENSIONSDIR); \
  done
	$(RM) -rf $(SONGBIRD_XULRUNNERDIR)/extensions
